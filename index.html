<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Lineage Graph</title>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; background: #f8f9fa; }
        #sidebar { width: 320px; background: #2c3e50; color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10; overflow-y: auto; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8em; color: #bdc3c7; margin-bottom: 4px; }
        input, select { width: 100%; padding: 8px; border-radius: 4px; border: none; margin-bottom: 10px; font-size: 14px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #submit-btn { background: #27ae60; color: white; }
        #submit-btn:hover { background: #2ecc71; }
        .btn-clear { background: #7f8c8d; color: white; margin-top: 8px; }
        #main-view { flex-grow: 1; position: relative; overflow: hidden; }
        svg { width: 100%; height: 100%; cursor: grab; }
        .node circle { stroke: #fff; stroke-width: 2px; cursor: pointer; }
        .node circle.selected { stroke: #f1c40f; stroke-width: 4px; }
        .link { stroke: #999; stroke-opacity: 0.4; stroke-width: 2px; }
        .spouse-link { stroke: #e74c3c; stroke-width: 3px; stroke-dasharray: 5,5; }
        text { font-size: 13px; font-weight: bold; pointer-events: none; fill: #2c3e50; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 id="form-title">âž• Add Member</h3>
    <div class="form-group">
        <label>Name</label>
        <input type="text" id="member-name" placeholder="Full Name">
    </div>
    <div class="form-group">
        <label>Parent 1</label>
        <select id="parent-1-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Parent 2</label>
        <select id="parent-2-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Spouse</label>
        <select id="spouse-select"><option value="">None</option></select>
    </div>
    <button id="submit-btn" class="btn" onclick="handleSave()">Save Member</button>
    <button class="btn btn-clear" onclick="resetForm()">Clear / New Member</button>
</div>

<div id="main-view">
    <div id="graph"></div>
</div>

<script>
    const SUPABASE_URL = 'https://qpeorqovecuyrutfbbkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jPDlKDqjVeOABl37jjWF2Q_nozLNYNj';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedMemberId = null;
    let allMembers = [];

    async function loadData() {
        const { data: members, error } = await supabaseClient.from('family_members').select('*');
        if (error) return console.error(error);
        allMembers = members || [];

        // Fill Dropdowns
        const selects = ['parent-1-select', 'parent-2-select', 'spouse-select'];
        selects.forEach(s => {
            const el = document.getElementById(s);
            el.innerHTML = '<option value="">None</option>';
            allMembers.forEach(m => {
                el.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
        });

        renderGraph(allMembers);
    }

    function renderGraph(data) {
        const width = window.innerWidth - 320;
        const height = window.innerHeight;

        d3.select("#graph").selectAll("*").remove();
        const svg = d3.select("#graph").append("svg")
            .attr("viewBox", [0, 0, width, height]);
        
        const container = svg.append("g");

        svg.call(d3.zoom().on("zoom", (event) => container.attr("transform", event.transform)));

        // Relationships
        const links = [];
        data.forEach(d => {
            if (d.parent_id) links.push({ source: d.parent_id, target: d.id, type: 'parent' });
            if (d.parent_2_id) links.push({ source: d.parent_2_id, target: d.id, type: 'parent' });
            if (d.spouse_id) links.push({ source: d.id, target: d.spouse_id, type: 'spouse' });
        });

        const simulation = d3.forceSimulation(data)
            .force("link", d3.forceLink(links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = container.append("g")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("class", d => d.type === 'spouse' ? "spouse-link" : "link");

        const node = container.append("g")
            .selectAll("g")
            .data(data)
            .join("g")
            .attr("class", "node")
            .on("click", (event, d) => editMember(d))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle").attr("r", 15).attr("fill", "#3498db")
            .classed("selected", d => d.id === selectedMemberId);

        node.append("text").text(d => d.name).attr("x", 20).attr("y", 5);

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
        function dragended(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
    }

    function editMember(member) {
        selectedMemberId = member.id;
        document.getElementById('form-title').innerText = "ðŸ“ Edit: " + member.name;
        document.getElementById('member-name').value = member.name;
        document.getElementById('parent-1-select').value = member.parent_id || "";
        document.getElementById('parent-2-select').value = member.parent_2_id || "";
        document.getElementById('spouse-select').value = member.spouse_id || "";
        document.getElementById('submit-btn').innerText = "Update Member";
        document.getElementById('submit-btn').style.background = "#e67e22";
        
        // Visual cue: highlight the circle
        d3.selectAll("circle").classed("selected", false);
        d3.selectAll("circle").filter(d => d.id === member.id).classed("selected", true);
    }

    function resetForm() {
        selectedMemberId = null;
        document.getElementById('form-title').innerText = "âž• Add Member";
        document.getElementById('member-name').value = "";
        document.getElementById('parent-1-select').value = "";
        document.getElementById('parent-2-select').value = "";
        document.getElementById('spouse-select').value = "";
        document.getElementById('submit-btn').innerText = "Save Member";
        document.getElementById('submit-btn').style.background = "#27ae60";
        d3.selectAll("circle").classed("selected", false);
    }

    async function handleSave() {
        const name = document.getElementById('member-name').value;
        const p1 = document.getElementById('parent-1-select').value;
        const p2 = document.getElementById('parent-2-select').value;
        const sp = document.getElementById('spouse-select').value;

        if (!name) return alert("Please enter a name");

        const memberData = {
            name: name,
            parent_id: p1 || null,
            parent_2_id: p2 || null,
            spouse_id: sp || null
        };

        let result;
        if (selectedMemberId) {
            // Update Existing
            result = await supabaseClient.from('family_members').update(memberData).eq('id', selectedMemberId);
        } else {
            // Insert New
            result = await supabaseClient.from('family_members').insert([memberData]);
        }

        if (result.error) alert(result.error.message);
        else location.reload();
    }

    loadData();
</script>
</body>
</html>