<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Family Tree</title>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; background: #f0f2f5; }
        #sidebar { width: 320px; background: #2c3e50; color: white; padding: 25px; box-shadow: 4px 0 10px rgba(0,0,0,0.2); z-index: 10; }
        h3 { margin-top: 0; color: #3498db; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.85em; color: #bdc3c7; }
        input, select { width: 100%; padding: 10px; border-radius: 4px; border: none; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn:hover { background: #2ecc71; }
        .btn-secondary { background: #7f8c8d; margin-top: 5px; }
        #main-view { flex-grow: 1; position: relative; overflow: auto; }
        .node circle { fill: #3498db; stroke: #fff; stroke-width: 3px; cursor: pointer; transition: 0.2s; }
        .node text { font: 14px sans-serif; font-weight: bold; pointer-events: none; }
        .link { fill: none; stroke: #bdc3c7; stroke-width: 2px; }
        .instructions { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 id="form-title">‚ûï Add Member</h3>
    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="member-name" placeholder="e.g. John Smith">
    </div>
    <div class="form-group">
        <label>Birth Year (Approx)</label>
        <input type="number" id="birth-year" placeholder="1950">
    </div>
    <div class="form-group">
        <label>Parent</label>
        <select id="parent-select">
            <option value="">Unknown / Root</option>
        </select>
    </div>
    <button class="btn" id="submit-btn" onclick="handleSave()">Add to Tree</button>
    <button class="btn btn-secondary" onclick="resetForm()">Clear / New</button>
</div>

<div id="main-view">
    <div id="tree-container"></div>
    <div class="instructions">Click a circle to edit or link that person to a parent.</div>
</div>

<script>
    // 1. CONFIGURATION
    const SUPABASE_URL = 'https://qpeorqovecuyrutfbbkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jPDlKDqjVeOABl37jjWF2Q_nozLNYNj';
    
    // Fixed initialization syntax
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedMemberId = null;

    // 2. LOAD DATA FROM SUPABASE
    async function loadData() {
        const { data: members, error } = await supabase
            .from('family_members')
            .select('*')
            .order('name', { ascending: true });

        if (error) {
            console.error("Supabase Error:", error.message);
            return;
        }

        const select = document.getElementById('parent-select');
        select.innerHTML = '<option value="">Unknown / Root</option>';
        members.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m.id;
            opt.innerHTML = m.name;
            select.appendChild(opt);
        });

        if (members && members.length > 0) renderTree(members);
    }

    // 3. RENDER TREE WITH D3.JS
    function renderTree(data) {
        d3.select("#tree-container").selectAll("*").remove();
        const width = 1000, height = 800;

        try {
            const stratify = d3.stratify()
                .id(d => d.id)
                .parentId(d => d.parent_id);

            const root = stratify(data);
            const treeLayout = d3.tree().size([width - 200, height - 400]);
            treeLayout(root);

            const svg = d3.select("#tree-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(100,80)");

            svg.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

            const node = svg.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .on("click", (e, d) => selectMember(d.data));

            node.append("circle").attr("r", 15);
            node.append("text").attr("dy", ".35em").attr("y", 25)
                .style("text-anchor", "middle").text(d => d.data.name);

        } catch (e) {
            console.warn("Tree visualization error: This usually happens if there are multiple roots or loops in the data.");
        }
    }

    // 4. SAVE / UPDATE LOGIC
    async function handleSave() {
        const name = document.getElementById('member-name').value;
        const year = document.getElementById('birth-year').value;
        const parentId = document.getElementById('parent-select').value;

        if (!name) return alert("Name is required");

        const payload = { 
            name: name, 
            birth_year: year ? parseInt(year) : null, 
            parent_id: parentId ? parseInt(parentId) : null 
        };

        if (selectedMemberId) {
            const { error } = await supabase.from('family_members').update(payload).eq('id', selectedMemberId);
            if (error) alert(error.message);
        } else {
            const { error } = await supabase.from('family_members').insert([payload]);
            if (error) alert(error.message);
        }
        location.reload();
    }

    function selectMember(member) {
        selectedMemberId = member.id;
        document.getElementById('form-title').innerText = "üìù Edit " + member.name;
        document.getElementById('member-name').value = member.name;
        document.getElementById('birth-year').value = member.birth_year || "";
        document.getElementById('parent-select').value = member.parent_id || "";
        document.getElementById('submit-btn').innerText = "Update Info";
    }

    function resetForm() {
        selectedMemberId = null;
        document.getElementById('form-title').innerText = "‚ûï Add Member";
        document.getElementById('member-name').value = "";
        document.getElementById('birth-year').value = "";
        document.getElementById('parent-select').value = "";
        document.getElementById('submit-btn').innerText = "Add to Tree";
    }

    loadData();
</script>
</body>
</html>