<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Family Heritage</title>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2d5a27; 
            --accent: #e67e22; 
            --bg-sidebar: #1a1c1e;
            --bg-canvas: #fcfaf7;
            --text-main: #2c3e50;
            --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; display: flex; margin: 0; height: 100vh; background: var(--bg-canvas); color: var(--text-main); overflow: hidden; }
        
        #sidebar { 
            width: 320px; background: var(--bg-sidebar); color: #fff; padding: 30px 20px; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 10; overflow-y: auto;
        }
        h2 { font-weight: 300; letter-spacing: 1px; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 8px; }
        input, select { 
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #333; 
            background: #25282c; color: #fff; font-size: 14px; box-sizing: border-box;
        }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; margin-top: 10px; }
        #submit-btn { background: var(--primary); color: white; }
        .btn-reset { background: transparent; color: #888; border: 1px solid #333; }

        #main-view { flex-grow: 1; overflow: auto; position: relative; }
        #tree-canvas { min-width: 5000px; min-height: 5000px; padding: 100px; }

        .node rect { fill: var(--card-bg); stroke: #e0e0e0; stroke-width: 1px; rx: 8; ry: 8; cursor: pointer; }
        .node.selected rect { stroke: var(--primary); stroke-width: 3px; fill: #f0f7ef; }
        .node text { font-size: 13px; font-weight: 600; fill: var(--text-main); text-anchor: middle; pointer-events: none; }
        
        .link { fill: none; stroke: #d1d8dd; stroke-width: 2px; }
        .spouse-link { fill: none; stroke: var(--accent); stroke-width: 2px; stroke-dasharray: 6,4; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 id="form-title">Heritage</h2>
    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="member-name" placeholder="Enter name...">
    </div>
    <div class="form-group">
        <label>Parent 1</label>
        <select id="p1-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Parent 2</label>
        <select id="p2-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Spouse</label>
        <select id="spouse-select"><option value="">None</option></select>
    </div>
    <button id="submit-btn" class="btn" onclick="handleSave()">Save Connection</button>
    <button class="btn btn-reset" onclick="resetForm()">Add New Person</button>
</div>

<div id="main-view">
    <div id="tree-canvas"></div>
</div>

<script>
    const SUPABASE_URL = 'https://qpeorqovecuyrutfbbkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jPDlKDqjVeOABl37jjWF2Q_nozLNYNj';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedId = null;
    let allData = [];

    async function loadData() {
        const { data: members, error } = await supabaseClient.from('family_members').select('*');
        if (error) return console.error(error);
        allData = members || [];

        ['p1-select', 'p2-select', 'spouse-select'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.innerHTML = '<option value="">None</option>';
                allData.forEach(m => el.innerHTML += `<option value="${m.id}">${m.name}</option>`);
            }
        });

        drawClassicTree(allData);
    }

    function drawClassicTree(data) {
        d3.select("#tree-canvas").selectAll("*").remove();
        const svg = d3.select("#tree-canvas").append("svg").attr("width", 5000).attr("height", 3000);
        const g = svg.append("g").attr("transform", "translate(150,150)");

        const nodeW = 160, nodeH = 60, vertGap = 180, horizGap = 200;

        const nodes = data.map(d => ({ ...d }));
        
        // 1. Calculate Generation Levels
        nodes.forEach(n => {
            let depth = 0, current = n, visited = new Set();
            while (current && (current.parent_id || current.parent_2_id)) {
                if (visited.has(current.id)) break;
                visited.add(current.id);
                depth++;
                current = nodes.find(p => p.id == current.parent_id || p.id == current.parent_2_id);
            }
            n.level = depth;
        });

        // 2. Cluster Positioning (Spouses side-by-side)
        const levels = [...new Set(nodes.map(n => n.level))].sort((a,b) => a-b);
        levels.forEach(lvl => {
            let currentX = 0;
            const nodesInLevel = nodes.filter(n => n.level === lvl);
            const placed = new Set();

            nodesInLevel.forEach(n => {
                if (placed.has(n.id)) return;

                // Place Primary Node
                n.x = currentX;
                n.y = n.level * vertGap;
                placed.add(n.id);

                // Check for Spouse in same level
                if (n.spouse_id) {
                    const spouse = nodes.find(s => s.id == n.spouse_id && s.level === lvl);
                    if (spouse && !placed.has(spouse.id)) {
                        currentX += horizGap; 
                        spouse.x = currentX;
                        spouse.y = n.level * vertGap;
                        placed.add(spouse.id);
                    }
                }
                // Add extra space before next family unit/individual
                currentX += horizGap * 1.8; 
            });
        });

        // 3. Draw Relationship Links
        nodes.forEach(n => {
            [n.parent_id, n.parent_2_id].forEach(pid => {
                if (pid) {
                    const p = nodes.find(x => x.id == pid);
                    if (p) {
                        const midY = (p.y + nodeH + n.y) / 2;
                        g.append("path").attr("class", "link")
                            .attr("d", `M ${p.x + nodeW/2} ${p.y + nodeH} L ${p.x + nodeW/2} ${midY} L ${n.x + nodeW/2} ${midY} L ${n.x + nodeW/2} ${n.y}`);
                    }
                }
            });
            if (n.spouse_id) {
                const s = nodes.find(x => x.id == n.spouse_id);
                if (s) {
                    g.append("path").attr("class", "spouse-link")
                        .attr("d", `M ${n.x + nodeW} ${n.y + nodeH/2} L ${s.x} ${s.y + nodeH/2}`);
                }
            }
        });

        // 4. Draw Node Cards
        const nodeG = g.selectAll(".node").data(nodes).enter().append("g")
            .attr("class", d => "node" + (d.id === selectedId ? " selected" : ""))
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .on("click", (e, d) => editMode(d));

        nodeG.append("rect").attr("width", nodeW).attr("height", nodeH);
        nodeG.append("text").attr("class", "name").attr("x", nodeW/2).attr("y", nodeH/2 + 6).text(d => d.name);
    }

    function editMode(d) {
        selectedId = d.id;
        document.getElementById('form-title').innerText = "Edit Profile";
        document.getElementById('member-name').value = d.name;
        document.getElementById('p1-select').value = d.parent_id || "";
        document.getElementById('p2-select').value = d.parent_2_id || "";
        document.getElementById('spouse-select').value = d.spouse_id || "";
        document.getElementById('submit-btn').innerText = "Update Record";
        drawClassicTree(allData);
    }

    function resetForm() {
        selectedId = null;
        document.getElementById('form-title').innerText = "Heritage";
        document.getElementById('member-name').value = "";
        document.getElementById('p1-select').value = "";
        document.getElementById('p2-select').value = "";
        document.getElementById('spouse-select').value = "";
        document.getElementById('submit-btn').innerText = "Save Connection";
        drawClassicTree(allData);
    }

    async function handleSave() {
        const name = document.getElementById('member-name').value;
        if (!name) return alert("Name required");
        const body = {
            name: name,
            parent_id: document.getElementById('p1-select').value || null,
            parent_2_id: document.getElementById('p2-select').value || null,
            spouse_id: document.getElementById('spouse-select').value || null
        };
        if (selectedId) await supabaseClient.from('family_members').update(body).eq('id', selectedId);
        else await supabaseClient.from('family_members').insert([body]);
        location.reload();
    }
    loadData();
</script>
</body>
</html>