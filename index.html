<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classic Family Tree Graph</title>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; margin: 0; height: 100vh; background: #f4f7f6; }
        #sidebar { width: 320px; background: #2c3e50; color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8em; color: #bdc3c7; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border-radius: 4px; border: none; background: #34495e; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        #submit-btn { background: #27ae60; color: white; }
        #submit-btn:hover { background: #2ecc71; }
        .btn-reset { background: #7f8c8d; color: white; }
        
        #main-view { flex-grow: 1; overflow: auto; background: white; position: relative; }
        .node rect { fill: white; stroke: #3498db; stroke-width: 2px; rx: 6; ry: 6; cursor: pointer; }
        .node.selected rect { stroke: #f1c40f; stroke-width: 4px; }
        .node text { font-size: 13px; font-weight: 600; fill: #2c3e50; text-anchor: middle; pointer-events: none; }
        .link { fill: none; stroke: #bdc3c7; stroke-width: 2px; }
        .spouse-link { fill: none; stroke: #e74c3c; stroke-width: 3px; stroke-dasharray: 4; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 id="form-title">‚ûï Add Member</h3>
    <div class="form-group">
        <label>Name</label>
        <input type="text" id="member-name" placeholder="Full Name">
    </div>
    <div class="form-group">
        <label>Parent 1</label>
        <select id="p1-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Parent 2</label>
        <select id="p2-select"><option value="">None</option></select>
    </div>
    <div class="form-group">
        <label>Spouse</label>
        <select id="sp-select"><option value="">None</option></select>
    </div>
    <button id="submit-btn" class="btn" onclick="handleSave()">Save Member</button>
    <button class="btn btn-reset" onclick="resetForm()">New Member / Clear</button>
</div>

<div id="main-view">
    <div id="tree-canvas"></div>
</div>

<script>
    const SUPABASE_URL = 'https://qpeorqovecuyrutfbbkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jPDlKDqjVeOABl37jjWF2Q_nozLNYNj';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedId = null;
    let allData = [];

    async function loadData() {
        const { data: members, error } = await supabaseClient.from('family_members').select('*');
        if (error) return console.error(error);
        allData = members || [];

        const menus = ['p1-select', 'p2-select', 'sp-select'];
        menus.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">None</option>';
            allData.forEach(m => el.innerHTML += `<option value="${m.id}">${m.name}</option>`);
        });

        drawClassicTree(allData);
    }

    function drawClassicTree(data) {
        d3.select("#tree-canvas").selectAll("*").remove();
        const width = 1600, height = 1200;
        const svg = d3.select("#tree-canvas").append("svg").attr("width", width).attr("height", height);
        const g = svg.append("g").attr("transform", "translate(100,100)");

        const nodeW = 140, nodeH = 50, vertGap = 120, horizGap = 180;

        // 1. Level Calculation (Generations)
        const nodes = data.map(d => ({ ...d }));
        nodes.forEach(n => {
            let depth = 0;
            let current = n;
            const visited = new Set();
            while (current && (current.parent_id || current.parent_2_id)) {
                if (visited.has(current.id)) break; // Prevent infinite loops
                visited.add(current.id);
                depth++;
                // Trace up through Parent 1 primarily for leveling
                current = nodes.find(p => p.id == current.parent_id || p.id == current.parent_2_id);
            }
            n.level = depth;
        });

        // 2. Position Calculation
        const levelCounts = {};
        nodes.forEach(n => {
            if (!levelCounts[n.level]) levelCounts[n.level] = 0;
            n.x = levelCounts[n.level] * horizGap;
            n.y = n.level * vertGap;
            levelCounts[n.level]++;
        });

        // 3. Draw Links (Parents & Spouses)
        nodes.forEach(n => {
            [n.parent_id, n.parent_2_id].forEach(pid => {
                if (pid) {
                    const p = nodes.find(x => x.id == pid);
                    if (p) {
                        g.append("path").attr("class", "link")
                            .attr("d", d3.linkVertical()({
                                source: [p.x + nodeW/2, p.y + nodeH],
                                target: [n.x + nodeW/2, n.y]
                            }));
                    }
                }
            });
            if (n.spouse_id) {
                const s = nodes.find(x => x.id == n.spouse_id);
                if (s) {
                    g.append("line").attr("class", "spouse-link")
                        .attr("x1", n.x + nodeW).attr("y1", n.y + nodeH/2)
                        .attr("x2", s.x).attr("y2", s.y + nodeH/2);
                }
            }
        });

        // 4. Draw Nodes
        const nodeG = g.selectAll(".node").data(nodes).enter().append("g")
            .attr("class", d => "node" + (d.id === selectedId ? " selected" : ""))
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .on("click", (e, d) => editMode(d));

        nodeG.append("rect").attr("width", nodeW).attr("height", nodeH);
        nodeG.append("text").attr("x", nodeW/2).attr("y", nodeH/2 + 5).text(d => d.name);
    }

    function editMode(d) {
        selectedId = d.id;
        document.getElementById('form-title').innerText = "üìù Edit: " + d.name;
        document.getElementById('member-name').value = d.name;
        document.getElementById('p1-select').value = d.parent_id || "";
        document.getElementById('p2-select').value = d.parent_2_id || "";
        document.getElementById('sp-select').value = d.spouse_id || "";
        document.getElementById('submit-btn').innerText = "Update Member";
        document.getElementById('submit-btn').style.background = "#e67e22";
        
        drawClassicTree(allData); // Refresh to show highlight
    }

    function resetForm() {
        selectedId = null;
        document.getElementById('form-title').innerText = "‚ûï Add Member";
        document.getElementById('member-name').value = "";
        document.getElementById('p1-select').value = "";
        document.getElementById('p2-select').value = "";
        document.getElementById('sp-select').value = "";
        document.getElementById('submit-btn').innerText = "Save Member";
        document.getElementById('submit-btn').style.background = "#27ae60";
        drawClassicTree(allData);
    }

    async function handleSave() {
        const name = document.getElementById('member-name').value;
        if (!name) return alert("Name is required");

        const body = {
            name: name,
            parent_id: document.getElementById('p1-select').value || null,
            parent_2_id: document.getElementById('p2-select').value || null,
            spouse_id: document.getElementById('sp-select').value || null
        };

        if (selectedId) {
            await supabaseClient.from('family_members').update(body).eq('id', selectedId);
        } else {
            await supabaseClient.from('family_members').insert([body]);
        }
        location.reload();
    }

    loadData();
</script>
</body>
</html>